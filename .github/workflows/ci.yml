# ===== FLEXT STANDARDS - CI/CD PIPELINE =====
# ==============================================================
# Zero Tolerance CI/CD - FLEXT Standard 2025
# Enterprise-grade continuous integration with maximum quality gates
# Python 3.13 + bleeding-edge tools with strict validation

name: ğŸš€ FLEXT Quality Gate - Zero Tolerance CI/CD

on:
  push:
    branches: [main, master, develop]
    paths-ignore:
      - "*.md"
      - "docs/**"
      - ".gitignore"
      - "LICENSE"
  pull_request:
    branches: [main, master, develop]
    paths-ignore:
      - "*.md"
      - "docs/**"
      - ".gitignore"
      - "LICENSE"
  schedule:
    - cron: "0 6 * * 1" # Weekly security scan
  workflow_dispatch:
    inputs:
      skip_tests:
        description: "Skip test execution"
        required: false
        default: "false"
        type: boolean
      security_scan:
        description: "Run extended security scan"
        required: false
        default: "false"
        type: boolean

# ===== GLOBAL CONFIGURATION =====
env:
  PYTHON_VERSION: "3.13"
  POETRY_VERSION: "1.8.4"
  FORCE_COLOR: "1"
  PRE_COMMIT_COLOR: "always"
  PYTHONUNBUFFERED: "1"
  PYTHONDONTWRITEBYTECODE: "1"
  PIP_NO_CACHE_DIR: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"

# ===== SECURITY & PERMISSIONS =====
permissions:
  contents: read
  security-events: write
  checks: write
  pull-requests: write
  actions: read

# ===== CONCURRENCY CONTROL =====
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===== PRE-FLIGHT CHECKS =====
  preflight:
    name: ğŸ” Pre-flight Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      python-changed: ${{ steps.changes.outputs.python }}
      config-changed: ${{ steps.changes.outputs.config }}
      skip-tests: ${{ steps.skip.outputs.skip-tests }}
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Detect Changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            python:
              - "src/**/*.py"
              - "tests/**/*.py"
              - "*.py"
            config:
              - "pyproject.toml"
              - "poetry.lock"
              - ".pre-commit-config.yaml"
              - "Makefile"

      - name: âš™ï¸ Check Skip Conditions
        id: skip
        run: |
          if [[ "${{ github.event.inputs.skip_tests }}" == "true" ]]; then
            echo "skip-tests=true" >> $GITHUB_OUTPUT
          else
            echo "skip-tests=false" >> $GITHUB_OUTPUT
          fi

  # ===== SECURITY SCANNING =====
  security:
    name: ğŸ›¡ï¸ Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: preflight
    if: needs.preflight.outputs.python-changed == 'true' || github.event_name == 'schedule'
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: ğŸ”§ Install Dependencies
        run: |
          poetry install --no-interaction --no-ansi --with dev

      - name: ğŸ” Bandit Security Scan
        run: |
          poetry run bandit -r src/ -f json -o bandit-report.json
          poetry run bandit -r src/ -f txt
        continue-on-error: false

      - name: ğŸ” Secret Detection
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

      - name: ğŸ“Š Upload Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json

      - name: ğŸ” Dependency Vulnerability Scan
        if: github.event.inputs.security_scan == 'true' || github.event_name == 'schedule'
        run: |
          poetry run safety check --json --output safety-report.json || true
          poetry run safety check

  # ===== CODE QUALITY MATRIX =====
  quality:
    name: ğŸ”¬ Quality Gate - ${{ matrix.check }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: preflight
    if: needs.preflight.outputs.python-changed == 'true' || needs.preflight.outputs.config-changed == 'true'
    strategy:
      fail-fast: false
      matrix:
        check:
          - "ğŸ¨ Format & Style"
          - "ğŸ” Type Checking"
          - "ğŸ§ª Linting"
          - "ğŸ“š Documentation"
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: ğŸ’¾ Cache Dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('poetry.lock') }}
          restore-keys: |
            venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-

      - name: ğŸ”§ Install Dependencies
        run: |
          poetry install --no-interaction --no-ansi --with dev

      - name: ğŸ¨ Format & Style Check
        if: matrix.check == 'ğŸ¨ Format & Style'
        run: |
          echo "::group::Black Format Check"
          poetry run black --check --diff src/ tests/
          echo "::endgroup::"

          echo "::group::isort Import Check"
          poetry run isort --check-only --diff src/ tests/
          echo "::endgroup::"

      - name: ğŸ” Type Checking
        if: matrix.check == 'ğŸ” Type Checking'
        run: |
          echo "::group::MyPy Type Analysis"
          poetry run mypy src/ --strict --no-error-summary
          echo "::endgroup::"

      - name: ğŸ§ª Linting
        if: matrix.check == 'ğŸ§ª Linting'
        run: |
          echo "::group::Ruff Comprehensive Linting"
          poetry run ruff check src/ tests/ --output-format=github
          echo "::endgroup::"

      - name: ğŸ“š Documentation
        if: matrix.check == 'ğŸ“š Documentation'
        run: |
          echo "::group::Documentation Build Test"
          if [ -f mkdocs.yml ]; then
            poetry run mkdocs build --strict
          else
            echo "No mkdocs.yml found - skipping documentation build"
          fi
          echo "::endgroup::"

  # ===== COMPREHENSIVE TESTING =====
  test:
    name: ğŸ§ª Test Suite - Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    needs: [preflight, quality]
    if: needs.preflight.outputs.skip-tests == 'false' && (needs.preflight.outputs.python-changed == 'true' || needs.preflight.outputs.config-changed == 'true')
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.13"]
        include:
          - os: ubuntu-latest
            python-version: "3.12" # Compatibility test
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: ğŸ“¦ Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: ğŸ’¾ Cache Dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ matrix.os }}-${{ matrix.python-version }}-${{ hashFiles('poetry.lock') }}
          restore-keys: |
            venv-${{ matrix.os }}-${{ matrix.python-version }}-

      - name: ğŸ”§ Install Dependencies
        run: |
          poetry install --no-interaction --no-ansi --with dev,test

      - name: ğŸ§ª Run Test Suite
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379/0
          PYTHONPATH: src
        run: |
          poetry run pytest tests/ \
            --cov=src \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --cov-fail-under=90 \
            --maxfail=1 \
            --tb=short \
            --durations=10 \
            --strict-markers \
            --strict-config \
            -v

      - name: ğŸ“Š Upload Coverage Reports
        uses: codecov/codecov-action@v4
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.13'
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: ğŸ“ˆ Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.os }}-${{ matrix.python-version }}
          path: |
            htmlcov/
            coverage.xml
            pytest-report.xml

  # ===== PRE-COMMIT VALIDATION =====
  pre-commit:
    name: ğŸ¤– Pre-commit Hooks
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: preflight
    if: needs.preflight.outputs.python-changed == 'true' || needs.preflight.outputs.config-changed == 'true'
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ’¾ Cache Pre-commit
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-${{ runner.os }}-

      - name: ğŸ”§ Install Pre-commit
        run: |
          python -m pip install pre-commit
          pre-commit install

      - name: ğŸƒ Run Pre-commit Hooks
        run: |
          pre-commit run --all-files --show-diff-on-failure

  # ===== BUILD & PACKAGE VALIDATION =====
  build:
    name: ğŸ“¦ Build & Package
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [quality, test]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: ğŸ”§ Install Dependencies
        run: |
          poetry install --no-interaction --no-ansi

      - name: ğŸ—ï¸ Build Package
        run: |
          poetry build

      - name: âœ… Validate Package
        run: |
          poetry run python -m pip install dist/*.whl
          poetry run python -c "import flext_quality"

      - name: ğŸ“Š Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: package-distributions
          path: dist/

  # ===== FINAL QUALITY SUMMARY =====
  quality-gate:
    name: ğŸ† Quality Gate Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [security, quality, test, pre-commit, build]
    if: always()
    steps:
      - name: ğŸ“Š Quality Gate Results
        run: |
          echo "## ğŸ† FLEXT Quality Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ›¡ï¸ Security | ${{ needs.security.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”¬ Quality | ${{ needs.quality.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ§ª Tests | ${{ needs.test.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ¤– Pre-commit | ${{ needs.pre-commit.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“¦ Build | ${{ needs.build.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.security.result }}" == "failure" ]] || \
             [[ "${{ needs.quality.result }}" == "failure" ]] || \
             [[ "${{ needs.test.result }}" == "failure" ]] || \
             [[ "${{ needs.pre-commit.result }}" == "failure" ]]; then
            echo "âŒ **Quality Gate FAILED** - Fix issues before merging" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… **Quality Gate PASSED** - Ready for deployment" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ‰ Success Notification
        if: success()
        run: |
          echo "ğŸ‰ All quality checks passed! Code meets FLEXT standards."

      - name: âŒ Failure Notification
        if: failure()
        run: |
          echo "âŒ Quality gate failed! Please fix the issues before proceeding."
          exit 1

# ===== FLEXT STANDARDS COMPLIANCE =====
# This workflow ensures:
# âœ… Zero tolerance for quality issues
# âœ… Comprehensive security scanning
# âœ… Multi-platform testing
# âœ… Complete coverage requirements
# âœ… Enterprise-grade CI/CD pipeline
# âœ… Automatic quality reporting
# âœ… Dependency vulnerability scanning
# âœ… Documentation validation
