name: Documentation Maintenance
on:
  schedule:
    # Run daily at 9 AM UTC
    - cron: '0 9 * * *'
  pull_request:
    paths:
      - 'docs/**'
      - '*.md'
      - '.github/workflows/docs-maintenance.yml'
  push:
    branches: [main, develop]
    paths:
      - 'docs/**'
      - '*.md'
  workflow_dispatch:    # Manual trigger

jobs:
  audit:
    name: Documentation Quality Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests beautifulsoup4 aiohttp jinja2

      - name: Create reports directory
        run: mkdir -p docs/maintenance/reports

      - name: Run Documentation Audit
        id: audit
        run: |
          cd docs/maintenance
          echo "Running comprehensive documentation audit..."
          python scripts/audit.py --comprehensive --output ../reports/
        continue-on-error: true

      - name: Generate Quality Report
        run: |
          cd docs/maintenance
          echo "Generating quality reports..."
          python scripts/report.py --format html --output ../reports/
          python scripts/report.py --format json --output ../reports/

      - name: Upload Audit Reports
        uses: actions/upload-artifact@v3
        with:
          name: docs-maintenance-reports
          path: docs/reports/
          retention-days: 30

      - name: Comment PR with Quality Summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Read the latest audit report
            const reportsDir = 'docs/maintenance/reports';
            const auditFile = path.join(reportsDir, 'latest_audit.json');

            let qualityScore = 0;
            let totalIssues = 0;
            let criticalIssues = 0;
            let highIssues = 0;

            if (fs.existsSync(auditFile)) {
              try {
                const report = JSON.parse(fs.readFileSync(auditFile, 'utf8'));
                qualityScore = report.metrics?.quality_score || 0;
                totalIssues = report.metrics?.total_issues || 0;
                criticalIssues = report.metrics?.severity_breakdown?.critical || 0;
                highIssues = report.metrics?.severity_breakdown?.high || 0;
              } catch (e) {
                console.log('Error reading audit report:', e);
              }
            }

            // Determine status emoji
            let statusEmoji = 'âœ…';
            if (criticalIssues > 0) statusEmoji = 'ðŸ”´';
            else if (highIssues > 5) statusEmoji = 'ðŸŸ ';
            else if (qualityScore < 70) statusEmoji = 'ðŸŸ¡';

            // Create comment
            const body = `## ${statusEmoji} Documentation Quality Check

**Quality Score:** ${qualityScore}/100
**Issues Found:** ${totalIssues}
- Critical: ${criticalIssues}
- High: ${highIssues}

### ðŸ“Š Audit Results
- **Files Analyzed:** ${report.metrics?.files_analyzed || 0}
- **Medium Issues:** ${report.metrics?.severity_breakdown?.medium || 0}
- **Low Issues:** ${report.metrics?.severity_breakdown?.low || 0}

### ðŸ“‹ Recommendations
${report.recommendations ? report.recommendations.slice(0, 5).map(r => `- ${r.description || r}`).join('\n') : 'No specific recommendations available'}

[ðŸ“„ View Full Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail on Critical Issues
        if: steps.audit.outcome == 'failure' || (github.event_name == 'pull_request' && criticalIssues > 0)
        run: |
          echo "âŒ Documentation audit found critical issues or failed"
          echo "Quality Score: ${qualityScore}/100"
          echo "Critical Issues: ${criticalIssues}"
          echo "High Issues: ${highIssues}"
          exit 1

  optimize:
    name: Documentation Optimization
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    needs: audit
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests beautifulsoup4 aiohttp jinja2

      - name: Run Documentation Optimization
        run: |
          cd docs/maintenance
          echo "Running documentation optimization..."
          python scripts/optimize.py --comprehensive --backup --output ../reports/

      - name: Check for Changes
        id: changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Documentation optimizations applied"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "âœ¨ No optimization changes needed"
          fi

      - name: Commit Optimization Changes
        if: steps.changes.outputs.changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "docs: automated optimization and formatting improvements

- Fixed formatting issues and style inconsistencies
- Enhanced accessibility and readability
- Updated table of contents where applicable
- Applied automated quality improvements

Auto-generated by documentation maintenance workflow" || echo "No changes to commit"

      - name: Create Pull Request for Optimizations
        if: steps.changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: automated optimization and formatting improvements"
          title: "ðŸ¤– Documentation Maintenance: Automated Optimizations"
          body: |
            ## ðŸ¤– Automated Documentation Maintenance

            This PR contains automated documentation improvements and optimizations:

            ### Changes Made
            - Fixed formatting issues and style inconsistencies
            - Enhanced accessibility and readability
            - Updated table of contents where applicable
            - Applied automated quality improvements

            ### Quality Metrics
            - **Audit Score:** ${{ env.QUALITY_SCORE }}/100
            - **Issues Resolved:** ${{ env.TOTAL_ISSUES }}

            ### Files Modified
            $(git diff --name-only HEAD~1)

            ---
            *This PR was automatically generated by the documentation maintenance workflow.*
          branch: docs/automated-maintenance
          delete-branch: true
          labels: |
            documentation
            automated
            maintenance

  validate:
    name: Link and Reference Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests beautifulsoup4 aiohttp jinja2

      - name: Run Link Validation
        run: |
          cd docs/maintenance
          echo "Validating links and references..."
          python scripts/validate.py --external-links --internal-links --images --output ../reports/

      - name: Upload Validation Reports
        uses: actions/upload-artifact@v3
        with:
          name: docs-validation-reports
          path: docs/reports/
          retention-days: 7

  weekly-report:
    name: Weekly Quality Report
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 9 * * 1'  # Only on Mondays
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests beautifulsoup4 aiohttp jinja2

      - name: Generate Weekly Trend Report
        run: |
          cd docs/maintenance
          echo "Generating weekly quality trends..."
          python scripts/report.py --weekly-trends --format html --output ../reports/

      - name: Upload Weekly Report
        uses: actions/upload-artifact@v3
        with:
          name: docs-weekly-report
          path: docs/reports/
          retention-days: 90