# ===== FLEXT STANDARDS - RELEASE PIPELINE =====
# ==============================================================
# Automated Release & Deployment - FLEXT Standard 2025
# Enterprise-grade release management with semantic versioning

name: ğŸš€ Release & Deploy

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 1.2.3)"
        required: true
        type: string
      prerelease:
        description: "Is this a pre-release?"
        required: false
        default: false
        type: boolean

# ===== GLOBAL CONFIGURATION =====
env:
  PYTHON_VERSION: "3.13"
  POETRY_VERSION: "1.8.4"
  FORCE_COLOR: "1"

# ===== SECURITY & PERMISSIONS =====
permissions:
  contents: write
  packages: write
  pull-requests: write
  issues: write

# ===== CONCURRENCY CONTROL =====
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ===== VALIDATION =====
  validate:
    name: ğŸ” Release Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      is-prerelease: ${{ steps.version.outputs.is-prerelease }}
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ Extract Version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            TAG="v${VERSION}"
            IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            TAG="${{ github.ref_name }}"
            VERSION="${TAG#v}"
            if [[ "$VERSION" =~ -[a-zA-Z] ]]; then
              IS_PRERELEASE="true"
            else
              IS_PRERELEASE="false"
            fi
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "is-prerelease=${IS_PRERELEASE}" >> $GITHUB_OUTPUT

          echo "## ğŸ·ï¸ Release Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${TAG}" >> $GITHUB_STEP_SUMMARY
          echo "- **Pre-release:** ${IS_PRERELEASE}" >> $GITHUB_STEP_SUMMARY

      - name: âœ… Validate Version Format
        run: |
          if [[ ! "${{ steps.version.outputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$ ]]; then
            echo "âŒ Invalid version format: ${{ steps.version.outputs.version }}"
            echo "Expected format: MAJOR.MINOR.PATCH[-PRERELEASE][+BUILDMETADATA]"
            exit 1
          fi

  # ===== QUALITY GATE =====
  quality-gate:
    name: ğŸ”¬ Pre-Release Quality Gate
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: validate
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: ğŸ”§ Install Dependencies
        run: |
          poetry install --no-interaction --no-ansi --with dev

      - name: ğŸ”¬ Run Full Quality Gate
        env:
          PYTHONPATH: src
        run: |
          echo "::group::Security Scan"
          poetry run bandit -r src/ -f json -o bandit-report.json
          echo "::endgroup::"

          echo "::group::Type Checking"
          poetry run mypy src/ --strict --no-error-summary
          echo "::endgroup::"

          echo "::group::Linting"
          poetry run ruff check src/ tests/ --output-format=github
          echo "::endgroup::"

          echo "::group::Format Check"
          poetry run black --check --diff src/ tests/
          poetry run isort --check-only --diff src/ tests/
          echo "::endgroup::"

          echo "::group::Test Suite"
          poetry run pytest tests/ \
            --cov=src \
            --cov-fail-under=90 \
            --maxfail=1 \
            --tb=short \
            -q
          echo "::endgroup::"

  # ===== BUILD & PACKAGE =====
  build:
    name: ğŸ“¦ Build Release Package
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [validate, quality-gate]
    outputs:
      artifact-name: ${{ steps.build.outputs.artifact-name }}
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: ğŸ”§ Update Version
        run: |
          poetry version ${{ needs.validate.outputs.version }}

      - name: ğŸ”§ Install Dependencies
        run: |
          poetry install --no-interaction --no-ansi

      - name: ğŸ—ï¸ Build Package
        id: build
        run: |
          poetry build

          # Generate build info
          echo "## ğŸ“¦ Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Package:** flext_quality" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Built:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **Python:** ${{ env.PYTHON_VERSION }}" >> $GITHUB_STEP_SUMMARY

          # List build artifacts
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Artifacts" >> $GITHUB_STEP_SUMMARY
          ls -la dist/ >> $GITHUB_STEP_SUMMARY

          # Set output
          echo "artifact-name=release-${{ needs.validate.outputs.version }}" >> $GITHUB_OUTPUT

      - name: âœ… Validate Package
        run: |
          # Test wheel installation
          python -m pip install dist/*.whl
          python -c "import flext_quality; print(f'âœ… Package flext_quality imported successfully')"

      - name: ğŸ“Š Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.artifact-name }}
          path: |
            dist/
            CHANGELOG.md
            README.md
          retention-days: 30

  # ===== GENERATE CHANGELOG =====
  changelog:
    name: ğŸ“ Generate Changelog
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: validate
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“ Generate Release Notes
        id: changelog
        run: |
          # Get the previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          CURRENT_TAG="${{ needs.validate.outputs.tag }}"

          echo "## ğŸ‰ What's New in ${CURRENT_TAG}" > release_notes.md
          echo "" >> release_notes.md

          if [[ -n "$PREVIOUS_TAG" ]]; then
            echo "### ğŸ“‹ Changes since ${PREVIOUS_TAG}" >> release_notes.md
            echo "" >> release_notes.md

            # Generate commit log
            git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges >> release_notes.md
          else
            echo "### ğŸ‰ Initial Release" >> release_notes.md
            echo "" >> release_notes.md
            echo "- First release of flext-quality" >> release_notes.md
          fi

          echo "" >> release_notes.md
          echo "### ğŸ”§ Technical Details" >> release_notes.md
          echo "- **Version:** ${{ needs.validate.outputs.version }}" >> release_notes.md
          echo "- **Python:** ${{ env.PYTHON_VERSION }}+" >> release_notes.md
          echo "- **Release Date:** $(date -u +"%Y-%m-%d")" >> release_notes.md

          # Set output (escape newlines for GitHub)
          {
            echo 'changelog<<EOF'
            cat release_notes.md
            echo EOF
          } >> $GITHUB_OUTPUT

      - name: ğŸ“Š Upload Changelog
        uses: actions/upload-artifact@v4
        with:
          name: changelog-${{ needs.validate.outputs.version }}
          path: release_notes.md

  # ===== GITHUB RELEASE =====
  github-release:
    name: ğŸš€ Create GitHub Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [validate, build, changelog]
    steps:
      - name: ğŸ“¥ Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: ./artifacts

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.validate.outputs.tag }}
          name: "Release ${{ needs.validate.outputs.version }}"
          body: ${{ needs.changelog.outputs.changelog }}
          prerelease: ${{ needs.validate.outputs.is-prerelease == 'true' }}
          draft: false
          files: |
            ./artifacts/dist/*
          token: ${{ secrets.GITHUB_TOKEN }}

  # ===== PYPI PUBLICATION =====
  pypi-publish:
    name: ğŸ“¦ Publish to PyPI
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [validate, build, github-release]
    if: needs.validate.outputs.is-prerelease == 'false'
    environment:
      name: pypi
      url: https://pypi.org/project/flext_quality/
    steps:
      - name: ğŸ“¥ Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: ./artifacts

      - name: ğŸš€ Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: ./artifacts/dist/
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}
          verbose: true

  # ===== TESTPYPI PUBLICATION (PRE-RELEASES) =====
  testpypi-publish:
    name: ğŸ§ª Publish to TestPyPI
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [validate, build, github-release]
    if: needs.validate.outputs.is-prerelease == 'true'
    environment:
      name: testpypi
      url: https://test.pypi.org/project/flext_quality/
    steps:
      - name: ğŸ“¥ Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: ./artifacts

      - name: ğŸ§ª Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: ./artifacts/dist/
          repository-url: https://test.pypi.org/legacy/
          user: __token__
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}
          verbose: true

  # ===== DOCKER IMAGE (IF APPLICABLE) =====
  docker-build:
    name: ğŸ³ Build Docker Image
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [validate, build]
    if: needs.validate.outputs.is-prerelease == 'false'
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: ./artifacts

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—ï¸ Build and Push Docker Image
        if: hashFiles('Dockerfile') != ''
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ needs.validate.outputs.version }}
          labels: |
            org.opencontainers.image.title=flext-quality
            org.opencontainers.image.version=${{ needs.validate.outputs.version }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}

  # ===== NOTIFICATION & CLEANUP =====
  notify:
    name: ğŸ“¢ Post-Release Notifications
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs:
      [validate, github-release, pypi-publish, testpypi-publish, docker-build]
    if: always()
    steps:
      - name: ğŸ“Š Release Summary
        run: |
          echo "## ğŸ‰ Release ${{ needs.validate.outputs.version }} Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸš€ GitHub Release | ${{ needs.github-release.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“¦ PyPI | ${{ needs.pypi-publish.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ§ª TestPyPI | ${{ needs.testpypi-publish.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ³ Docker | ${{ needs.docker-build.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.github-release.result }}" == "success" ]]; then
            echo "âœ… **Release ${{ needs.validate.outputs.version }} completed successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ”— Links" >> $GITHUB_STEP_SUMMARY
            echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${{ needs.validate.outputs.tag }})" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ needs.pypi-publish.result }}" == "success" ]]; then
              echo "- [PyPI Package](https://pypi.org/project/flext_quality/${{ needs.validate.outputs.version }}/)" >> $GITHUB_STEP_SUMMARY
            fi
            if [[ "${{ needs.testpypi-publish.result }}" == "success" ]]; then
              echo "- [TestPyPI Package](https://test.pypi.org/project/flext_quality/${{ needs.validate.outputs.version }}/)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **Release ${{ needs.validate.outputs.version }} failed!**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ‰ Success
        if: success()
        run: |
          echo "ğŸ‰ Release ${{ needs.validate.outputs.version }} completed successfully!"

      - name: âŒ Failure
        if: failure()
        run: |
          echo "âŒ Release ${{ needs.validate.outputs.version }} failed!"
          exit 1

# ===== FLEXT STANDARDS COMPLIANCE =====
# This workflow ensures:
# âœ… Semantic versioning enforcement
# âœ… Quality gate before release
# âœ… Automated changelog generation
# âœ… Multi-target publishing (PyPI, TestPyPI)
# âœ… Docker image building
# âœ… Comprehensive release validation
# âœ… Enterprise-grade release management
