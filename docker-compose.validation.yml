version: '3.8'

services:
  # Main FLEXT Quality validation service
  flext-quality:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: flext-quality-validation
    volumes:
      # Mount source for development and validation
      - .:/app:ro
      # Volume for generated reports and outputs
      - validation_outputs:/app/outputs
    environment:
      - PYTHONPATH=/app
      - FLEXT_QUALITY_ENV=container_validation
      - FLEXT_QUALITY_LOG_LEVEL=INFO
    ports:
      - "8000:8000"
    networks:
      - flext-network
    healthcheck:
      test: ["CMD", "python", "-c", "from flext_quality import CodeAnalyzer; print('âœ… Health OK')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # Test runner service for continuous validation
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: flext-quality-tests
    volumes:
      - .:/app:ro
      - test_outputs:/app/test_results
    environment:
      - PYTHONPATH=/app
      - PYTEST_CURRENT_TEST_ENABLED=1
    command: >
      bash -c "
        echo 'ðŸ§ª CONTINUOUS VALIDATION STARTING...' &&
        echo 'ðŸ“Š Running comprehensive test suite...' &&
        python -m pytest tests/ -v --cov=src --cov-report=html:/app/test_results/coverage --cov-report=term-missing --cov-fail-under=90 --tb=short &&
        echo 'ðŸ“‹ Validating all examples...' &&
        cd examples/basic/simple_analysis && python example.py /app/src &&
        cd ../../advanced/cli_integration && python example.py &&
        cd ../../integration/api_usage && python example.py &&
        echo 'ðŸ”§ Testing CLI functionality...' &&
        python -m flext_quality.cli analyze /app/src --format json > /app/test_results/cli_test.json &&
        python -m flext_quality.cli score /app/src &&
        echo 'âœ… ALL VALIDATIONS COMPLETED SUCCESSFULLY!' &&
        echo 'ðŸ“Š Results saved in /app/test_results/' &&
        tail -f /dev/null
      "
    networks:
      - flext-network
    depends_on:
      - flext-quality

  # Example validation service
  examples-validator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: flext-quality-examples
    volumes:
      - .:/app:ro
      - example_outputs:/app/example_results
    environment:
      - PYTHONPATH=/app
    command: >
      bash -c "
        echo 'ðŸ“‹ EXAMPLES COMPREHENSIVE VALIDATION...' &&
        echo 'ðŸ” Testing Basic Simple Analysis...' &&
        cd examples/basic/simple_analysis &&
        python example.py /app/src > /app/example_results/basic_example.log 2>&1 &&
        echo 'ðŸš€ Testing Advanced CLI Integration...' &&
        cd ../../advanced/cli_integration &&
        python example.py > /app/example_results/cli_example.log 2>&1 &&
        echo 'ðŸŒ Testing Complete API Integration...' &&
        cd ../../integration/api_usage &&
        python example.py > /app/example_results/api_example.log 2>&1 &&
        echo 'âœ… ALL EXAMPLES VALIDATED IN CONTAINER!' &&
        echo 'ðŸ“Š Example outputs saved in /app/example_results/' &&
        ls -la /app/example_results/ &&
        tail -f /dev/null
      "
    networks:
      - flext-network

networks:
  flext-network:
    driver: bridge

volumes:
  validation_outputs:
    driver: local
  test_outputs:
    driver: local
  example_outputs:
    driver: local