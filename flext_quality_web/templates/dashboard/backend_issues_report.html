{% extends 'base.html' %}
{% load static %}
{% load dashboard_extras %}

{% block title %}Backend Issues Report - {{ session.name }}{% endblock %}

{% block extra_css %}
<style>
    .backend-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 20px;
        overflow: hidden;
    }

    .backend-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: between;
        align-items: center;
    }

    .backend-stats {
        background: #f8f9fa;
        padding: 15px 20px;
        border-bottom: 1px solid #e0e0e0;
    }

    .stat-item {
        display: inline-block;
        margin-right: 20px;
        text-align: center;
    }

    .stat-value {
        font-size: 1.5em;
        font-weight: bold;
        color: #333;
    }

    .stat-label {
        font-size: 0.9em;
        color: #666;
        text-transform: uppercase;
    }

    .severity-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: bold;
        text-transform: uppercase;
    }

    .severity-critical { background: #dc3545; color: white; }
    .severity-high { background: #fd7e14; color: white; }
    .severity-medium { background: #ffc107; color: black; }
    .severity-low { background: #28a745; color: white; }
    .severity-info { background: #17a2b8; color: white; }

    .category-badge {
        padding: 3px 6px;
        border-radius: 3px;
        font-size: 0.75em;
        background: #6c757d;
        color: white;
        margin-right: 5px;
    }

    .issue-item {
        border-bottom: 1px solid #f0f0f0;
        padding: 10px 20px;
    }

    .issue-item:last-child {
        border-bottom: none;
    }

    .issue-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
    }

    .issue-code {
        font-family: 'Courier New', monospace;
        background: #f8f9fa;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.9em;
    }

    .file-path {
        font-family: 'Courier New', monospace;
        color: #666;
        font-size: 0.9em;
    }

    .line-number {
        color: #007bff;
        font-weight: bold;
    }

    .overview-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .overview-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
    }

    .overview-card h3 {
        margin: 0 0 10px 0;
        color: #333;
    }

    .overview-value {
        font-size: 2em;
        font-weight: bold;
        color: #007bff;
    }

    .chart-container {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .progress-bar {
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        height: 20px;
        margin: 5px 0;
    }

    .progress-fill {
        height: 100%;
        transition: width 0.3s ease;
    }

    .status-success { color: #28a745; }
    .status-failed { color: #dc3545; }
    .status-skipped { color: #6c757d; }

    .collapsible {
        cursor: pointer;
        user-select: none;
    }

    .collapsible:hover {
        background: rgba(255,255,255,0.1);
    }

    .collapsible-content {
        max-height: 400px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1>üîç Backend Issues Report</h1>
                    <p class="text-muted">{{ session.name }} - {{ session.started_at|date:"M d, Y H:i" }}</p>
                </div>
                <div>
                    <a href="{% url 'analysis_session_detail' session.id %}" class="btn btn-outline-primary">
                        ‚Üê Back to Analysis
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Overview Cards -->
    <div class="overview-cards">
        <div class="overview-card">
            <h3>üìä Total Issues</h3>
            <div class="overview-value">{{ total_issues }}</div>
            <small class="text-muted">Detected across all backends</small>
        </div>
        <div class="overview-card">
            <h3>üìÅ Files with Issues</h3>
            <div class="overview-value">{{ total_files_with_issues }}</div>
            <small class="text-muted">Out of {{ session.file_analyses.count }} analyzed</small>
        </div>
        <div class="overview-card">
            <h3>‚öôÔ∏è Backends Used</h3>
            <div class="overview-value">{{ backend_stats.count }}</div>
            <small class="text-muted">{{ session.backends_used|join:", " }}</small>
        </div>
        <div class="overview-card">
            <h3>‚è±Ô∏è Total Time</h3>
            <div class="overview-value">
                {% for stat in backend_stats %}
                    {% if forloop.first %}{{ stat.execution_time|floatformat:1 }}s{% endif %}
                {% empty %}
                    0s
                {% endfor %}
            </div>
            <small class="text-muted">Analysis execution time</small>
        </div>
    </div>

    <!-- Backend Statistics -->
    <div class="row">
        <div class="col-12">
            <h2>üîß Backend Performance</h2>
            {% for stat in backend_stats %}
            <div class="backend-card">
                <div class="backend-header collapsible" onclick="toggleBackendDetails('backend-{{ forloop.counter }}')">
                    <div>
                        <h4 style="margin: 0;">{{ stat.backend.display_name }}</h4>
                        <small>{{ stat.backend.description }}</small>
                    </div>
                    <div class="text-right">
                        <span class="status-{{ stat.status }}">
                            {% if stat.status == 'success' %}‚úÖ{% elif stat.status == 'failed' %}‚ùå{% else %}‚è≠Ô∏è{% endif %}
                            {{ stat.status|title }}
                        </span>
                    </div>
                </div>

                <div class="backend-stats">
                    <div class="stat-item">
                        <div class="stat-value">{{ stat.execution_time|floatformat:2 }}s</div>
                        <div class="stat-label">Execution Time</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ stat.files_processed }}</div>
                        <div class="stat-label">Files Processed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ stat.issues_found }}</div>
                        <div class="stat-label">Issues Found</div>
                    </div>
                    {% if stat.error_message %}
                    <div class="stat-item">
                        <div class="stat-value text-danger">Error</div>
                        <div class="stat-label">{{ stat.error_message|truncatechars:50 }}</div>
                    </div>
                    {% endif %}
                </div>

                <div id="backend-{{ forloop.counter }}" class="collapsible-content" style="display: none;">
                    {% if stat.backend.name in issues_by_backend %}
                        {% with backend_issues=issues_by_backend|get_item:stat.backend.name %}

                        <!-- Severity Distribution -->
                        <div style="padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0;">
                            <h6>Issue Severity Distribution</h6>
                            {% for severity, count in backend_issues.severity_counts.items %}
                                {% if count > 0 %}
                                <span class="severity-badge severity-{{ severity|lower }}">
                                    {{ severity }}: {{ count }}
                                </span>
                                {% endif %}
                            {% endfor %}
                        </div>

                        <!-- Recent Issues -->
                        <div style="max-height: 300px; overflow-y: auto;">
                            {% for issue in backend_issues.issues|slice:":10" %}
                            <div class="issue-item">
                                <div class="issue-header">
                                    <div>
                                        <span class="issue-code">{{ issue.issue_type.code }}</span>
                                        <span class="severity-badge severity-{{ issue.severity|lower }}">
                                            {{ issue.severity }}
                                        </span>
                                        <span class="category-badge">{{ issue.category }}</span>
                                    </div>
                                    <div class="file-path">
                                        {{ issue.file_path|truncatechars:50 }}:<span class="line-number">{{ issue.line_number }}</span>
                                    </div>
                                </div>
                                <div>
                                    <strong>{{ issue.issue_type.name }}</strong>
                                </div>
                                <div class="text-muted">
                                    {{ issue.message|truncatechars:100 }}
                                </div>
                            </div>
                            {% endfor %}

                            {% if backend_issues.issues|length > 10 %}
                            <div style="padding: 10px 20px; text-align: center; background: #f8f9fa;">
                                <small class="text-muted">
                                    ... and {{ backend_issues.issues|length|add:"-10" }} more issues
                                </small>
                            </div>
                            {% endif %}
                        </div>
                        {% endwith %}
                    {% else %}
                        <div style="padding: 20px; text-align: center; color: #666;">
                            No issues detected by this backend
                        </div>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="alert alert-info">
                No backend statistics available for this analysis session.
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Top Issue Types -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="chart-container">
                <h3>üèÜ Top Issue Types</h3>
                {% for issue_type in top_issue_types %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <span class="issue-code">{{ issue_type.issue_type__code }}</span>
                        <span class="severity-badge severity-{{ issue_type.issue_type__severity|lower }}">
                            {{ issue_type.issue_type__severity }}
                        </span>
                    </div>
                    <div>
                        <strong>{{ issue_type.count }}</strong>
                        <small class="text-muted">occurrences</small>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {% widthratio issue_type.count top_issue_types.0.count 100 %}%; background: #007bff;"></div>
                </div>
                {% empty %}
                <p class="text-muted">No issues detected</p>
                {% endfor %}
            </div>
        </div>

        <div class="col-md-6">
            <div class="chart-container">
                <h3>üìÅ Files with Most Issues</h3>
                {% for file in files_with_issues %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="file-path" style="flex: 1;">
                        {{ file.file_path|truncatechars:40 }}
                    </div>
                    <div>
                        <strong>{{ file.issue_count }}</strong>
                        <small class="text-muted">issues</small>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {% widthratio file.issue_count files_with_issues.0.issue_count 100 %}%; background: #dc3545;"></div>
                </div>
                {% empty %}
                <p class="text-muted">No files with issues</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Recent Issues -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="chart-container">
                <h3>üïí Recent Issues (Latest 50)</h3>
                {% for issue in detected_issues %}
                <div class="issue-item">
                    <div class="issue-header">
                        <div>
                            <span class="issue-code">{{ issue.issue_type.code }}</span>
                            <span class="severity-badge severity-{{ issue.severity|lower }}">
                                {{ issue.severity }}
                            </span>
                            <span class="category-badge">{{ issue.category }}</span>
                            <small class="text-muted">{{ issue.backend_name }}</small>
                        </div>
                        <div class="file-path">
                            {{ issue.file_path|truncatechars:60 }}:<span class="line-number">{{ issue.line_number }}</span>
                        </div>
                    </div>
                    <div>
                        <strong>{{ issue.issue_type.name }}</strong>
                    </div>
                    <div class="text-muted">
                        {{ issue.message|truncatechars:150 }}
                    </div>
                    {% if issue.code_snippet %}
                    <details style="margin-top: 10px;">
                        <summary style="cursor: pointer; color: #007bff;">View Code Snippet</summary>
                        <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 5px; font-size: 0.9em;"><code>{{ issue.code_snippet }}</code></pre>
                    </details>
                    {% endif %}
                </div>
                {% empty %}
                <p class="text-muted">No issues detected in this analysis.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
function toggleBackendDetails(elementId) {
    const element = document.getElementById(elementId);
    if (element.style.display === 'none') {
        element.style.display = 'block';
    } else {
        element.style.display = 'none';
    }
}

// Custom template filter simulation for getting dict items
document.addEventListener('DOMContentLoaded', function() {
    // Add any additional JavaScript functionality here
});
</script>
{% endblock %}
